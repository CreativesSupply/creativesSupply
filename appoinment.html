<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Book an Appointment</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4 mt-5">
          <div class="card shadow p-4">
            <h2 class="text-center mb-4">Photoshot Raya DayangYunk</h2>
            <form id="bookingForm">
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" id="name" class="form-control" required />
              </div>

              <div class="mb-3">
                <label for="phone" class="form-label">Phone Number</label>
                <input type="text" id="phone" class="form-control" required />
              </div>

              <div class="mb-3">
                <label for="ic" class="form-label">No IC</label>
                <input type="text" id="ic" class="form-control" />
              </div>

              <div class="mb-3">
                <label for="date" class="form-label">Select Date</label>
                <input type="date" id="date" class="form-control" required />
              </div>

              <div class="mb-3">
                <label class="form-label">Raya</label><br>
                
                <input type="radio" id="raya" name="season" value="raya">
                <label for="raya">Raya</label>
            
                <input type="radio" id="bukan-raya" name="season" value="bukan_raya">
                <label for="bukan-raya">Bukan Raya</label>
              </div>
            

              <div class="mb-3">
                <label class="form-label">Select Time</label>
                <div
                  id="time-options"
                  class="d-flex justify-content-evenly flex-wrap gap-2"
                >
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="09:30 AM"
                  >
                    09:30 AM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="10:00 AM"
                  >
                    10:00 AM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="10:30 AM"
                  >
                    10:30 AM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="11:00 AM"
                  >
                    11:00 AM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="11:30 AM"
                  >
                    11:30 AM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="12:00 PM"
                  >
                    12:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="12:30 PM"
                  >
                    12:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="01:00 PM"
                  >
                    01:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="01:30 PM"
                  >
                    01:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="02:00 PM"
                  >
                    02:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="02:30 PM"
                  >
                    02:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="03:00 PM"
                  >
                    03:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="03:30 PM"
                  >
                    03:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="04:00 PM"
                  >
                    04:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="04:30 PM"
                  >
                    04:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="05:00 PM"
                  >
                    05:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="05:30 PM"
                  >
                    05:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="06:00 PM"
                  >
                    06:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="06:30 PM"
                  >
                    06:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="07:00 PM"
                  >
                    07:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="07:30 PM"
                  >
                    07:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="08:00 PM"
                  >
                    08:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="08:30 PM"
                  >
                    08:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="09:00 PM"
                  >
                    09:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="09:30 PM"
                  >
                    09:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="10:00 PM"
                  >
                    10:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="10:30 PM"
                  >
                    10:30 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="11:00 PM"
                  >
                    11:00 PM
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-primary time-btn"
                    data-value="11:30 PM"
                  >
                    11:30 PM
                  </button>
                  <!-- <button type="button" class="btn btn-outline-primary time-btn" data-value="12:00 AM">12:00 AM</button> -->
                </div>
                <input type="hidden" id="time" name="time" required />
              </div>

              <div class="mb-3">
                <label for="people" class="form-label">Number of People</label>
                <input
                  type="number"
                  id="people"
                  class="form-control"
                  required
                />
              </div>

              <div class="mb-3">
                <label for="package" class="form-label">Package</label>
                <select id="package" class="form-control" required>
                  <option value="" disabled selected>Select a Package</option>
                  <option value="Pakej A">Pakej A - Kecil Ku ( RM 90 )</option>
                  <option value="Pakej B">Pakej B - Besar Ku ( RM 120 )</option>
                  <option value="Pakej C">
                    Pakej C - Bahagia Ku ( RM 220 )
                  </option>
                </select>
              </div>

              <div class="mb-3">
                <label for="addon" class="form-label">Add On</label>
                <div id="addon-options">
                  <label
                    ><input
                      type="checkbox"
                      name="addon[]"
                      value="Makeup"
                      data-price="100"
                    />
                    Makeup ( RM 100 )</label
                  ><br />
                  <label
                    ><input
                      type="checkbox"
                      name="addon[]"
                      value="Frame A"
                      data-price="50"
                    />
                    Frame 8x12 ( RM 50 )</label
                  ><br />
                  <label
                    ><input
                      type="checkbox"
                      name="addon[]"
                      value="Frame B"
                      data-price="150"
                    />
                    Frame 12x18 ( RM 150 )</label
                  ><br />
                  <label
                    ><input
                      type="checkbox"
                      name="addon[]"
                      value="Frame C"
                      data-price="250"
                    />
                    Frame 16x24 ( RM 250 )</label
                  >
                </div>
              </div>

              <div class="mb-3">
                <label for="deposit" class="form-label">Deposit (RM)</label>
                <input type="number" id="deposit" class="form-control" min="0"  />
              </div>

              <div class="mb-3">
                <label for="discount" class="form-label">Discount (RM)</label>
                <input type="number" id="discount" class="form-control" min="0"  />
              </div>

              <div class="mb-3">
                <label for="payment" class="form-label"
                  >Payment Amount (RM)</label
                >
                <input type="number" id="payment" class="form-control"/>
              </div>

              <div class="mb-3">
                <label for="balance" class="form-label"
                  >Balance Payment Amount (RM)</label
                >
                <input type="number" id="balance" class="form-control" readonly/>
              </div>

              <div class="mb-3">
                <label for="promoter" class="form-label">Promoter</label>
                <select id="promoter" class="form-control" required>
                  <option value="" disabled selected>Select a Promoter</option>
                  <option value="Dayang">Dayang</option>
                  <option value="Syafiq">Syafiq</option>
                  <option value="Nurul">Nurul</option>
                </select>
              </div>

              <div class="mb-3">
                <label for="remarks" class="form-label">Remarks</label>
                <textarea
                  type="text"
                  id="remarks"
                  class="form-control"
                ></textarea>
              </div>

              <button type="submit" class="btn btn-primary w-100">
                Submit
              </button>
              <a href="dayang-yunk-photoshot-raya.html" target="_blank"
                ><div class="btn btn-secondary w-100 mt-3">Appointments</div></a
              >
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelector("#payment").addEventListener("input", updateBalance);
        document.querySelector("#discount").addEventListener("input", updateBalance);
        document.querySelector("#deposit").addEventListener("input", updateBalance);
        document.querySelectorAll("input[name='addon[]']").forEach((checkbox) => {
          checkbox.addEventListener("change", updateBalance);
        });
        document.getElementById("package").addEventListener("change", updateBalance);
        document.querySelectorAll("input[name='season']").forEach((radio) => {
          radio.addEventListener("change", updateBalance);
        });
      });

      const restWeekday = [
        "04:30 PM", 
        "05:00 PM", 
        "05:30 PM",
        "06:00 PM",
        "06:30 PM",
        "07:00 PM",
        "07:30 PM",
        "08:00 PM",
        "08:30 PM"
      ];
      const restWeekend = [
        "07:00 PM",
        "07:30 PM"
      ];

      document.getElementById("date").addEventListener("change", function () {
        const selectedDate = new Date(this.value);
        // console.log(selectedDate);
        const dayOfWeek = selectedDate.getDay(); // 0 = Sunday, 6 = Saturday
        // console.log(dayOfWeek);
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        // console.log(isWeekend);

        document.querySelectorAll(".time-btn").forEach((button) => {
          const formattedTime = button.getAttribute("data-value");
          // const formattedTime = convertTo24HourFormat(timeValue);

          // console.log(timeValue);
          // console.log(formattedTime);
          if(isWeekend && restWeekend.includes(formattedTime)){
            button.style.display = "none"; // Hide rest times
          }else if(!isWeekend && restWeekday.includes(formattedTime)){
            button.style.display = "none"; // Hide rest times
          }else{
            button.style.display = "inline-block"; // Show available times

          }
          // if (restWeekday.includes(formattedTime) || (isWeekend && restWeekend.includes(formattedTime))) {
          //   button.style.display = "none"; // Hide rest times
          // } else {
          //   button.style.display = "inline-block"; // Show available times
          // }
        });
      });

      document.querySelectorAll(".time-btn").forEach((button) => {
        button.addEventListener("click", function () {
          document.getElementById("time").value =
            this.getAttribute("data-value");

          // Remove active class from all buttons
          document
            .querySelectorAll(".time-btn")
            .forEach((btn) => btn.classList.remove("btn-primary"));
          document
            .querySelectorAll(".time-btn")
            .forEach((btn) => btn.classList.add("btn-outline-primary"));

          // Add active class to selected button
          this.classList.add("btn-primary");
          this.classList.remove("btn-outline-primary");
        });
      });

      function convertTo24HourFormat(time12h) {
        const [time, modifier] = time12h.split(" ");
        let [hours, minutes] = time.split(":");

        if (modifier === "PM" && hours !== "12") {
          hours = String(parseInt(hours) + 12);
        } else if (modifier === "AM" && hours === "12") {
          hours = "00";
        }

        return `${hours}:${minutes} ${modifier}`;
      }
    </script>
    <script>
      // List of time slots
      const timeSlots = [
        "09:30 AM",
        "10:00 AM",
        "10:30 AM",
        "11:00 AM",
        "11:30 AM",
        "12:00 PM",
        "12:30 PM",
        "1:00 PM",
        "1:30 PM",
        "2:00 PM",
        "2:30 PM",
        "3:00 PM",
        "3:30 PM",
        "4:00 PM",
        "4:30 PM", //start rest weekday
        "5:00 PM",
        "5:30 PM",
        "6:00 PM", // start restweekend
        "6:30 PM",
        "7:00 PM",
        "7:30 PM",
        "8:00 PM", // end rest weekend  //weekday
        "8:30 PM",
        "9:00 PM",
        "9:30 PM",
        "10:00 PM",
        "10:30 PM",
        "11:00 PM",
        "11:30 PM",
      ];

      // Populate the select dropdown
      // const timeSelect = document.getElementById("time");
      // timeSlots.forEach((time) => {
      //   let option = document.createElement("option");
      //   option.value = time;
      //   option.textContent = time;
      //   timeSelect.appendChild(option);
      // });

      function updateBalance() {
        let payment       = parseFloat(document.querySelector("#payment").value) || 0;
        let discount      = parseFloat(document.querySelector("#discount").value) || 0;
        let deposit       = parseFloat(document.querySelector("#deposit").value) || 0;
        const package     = document.querySelector("#package").value;
        let pricePackage  = 0;

        // Declare addon checkboxes
        const addonCheckboxes = document.querySelectorAll("input[name='addon[]']");

        // Get total add-ons price
        const totalAddOnsPrice = getSelectedAddons().reduce((sum, addon) => sum + addon.price, 0);

        let isRaya = document.querySelector("input[name='season']:checked")?.value === "raya";

        // Package price assignment (fixing == issue)
        if (package === 'Pakej A') {
            pricePackage = 90;
        } else if (package === 'Pakej B') {
            pricePackage = 120;
        } else if (package === 'Pakej C') {
            pricePackage = 220;
        }

        // Balance calculation
        let balance = pricePackage + totalAddOnsPrice - payment - discount - deposit;

        if (isRaya) {
            balance += 50;
        }
        // Ensure balance is not NaN or negative
        if (isNaN(balance) || balance < 0) {
            balance = 0;
        }

        document.querySelector("#balance").value = balance.toFixed(2);
      }

      function getSelectedAddons() {
        const addonCheckboxes = document.querySelectorAll(
          "input[name='addon[]']"
        );
        let selectedAddons = [];
        addonCheckboxes.forEach((checkbox) => {
          if (checkbox.checked) {
            selectedAddons.push({
              name: checkbox.value,
              price: parseInt(checkbox.getAttribute("data-price")),
            });
          }
        });
        return selectedAddons;
      }

     
        
      async function submitAppointment(event) {
        event.preventDefault();

        // Get raw values
        const name      = document.querySelector("#name").value;
        const phone     = document.querySelector("#phone").value;
        const dateInput = document.querySelector("#date").value;
        const timeInput = document.querySelector("#time").value;
        const people    = document.querySelector("#people").value;
        const promoter  = document.querySelector("#promoter").value;
        const noIc      = document.querySelector("#ic").value;
        const package   = document.querySelector("#package").value;
        const remarks   = document.querySelector("#remarks").value;

        let payment = parseFloat(document.querySelector("#payment").value) || 0;
        let discount = parseFloat(document.querySelector("#discount").value) || 0;
        let deposit = parseFloat(document.querySelector("#deposit").value) || 0;
        let balance = parseFloat(document.querySelector("#balance").value) || 0;
        

        console.log(balance);

        const addonCheckboxes = document.querySelectorAll(
          "input[name='addon[]']"
        );

        addonCheckboxes.forEach((checkbox) => {
          checkbox.addEventListener("change", function () {
            console.log(getSelectedAddons()); // Output selected add-ons to console
          });
        });
        const addOns = getSelectedAddons()
          .map((addon) => `${addon.name}`)
          .join(", "); // Convert array to a comma-separated string

        // ✅ Convert Date to "7March" format
        const dateObj = new Date(dateInput);
        const day = dateObj.getDate(); // Get day (7)
        const month = dateObj.toLocaleString("en-US", { month: "long" }); // Get full month (March)
        const formattedDate = `${day}${month}`; // "7March"

        // ✅ Convert Time to "320PM" format
        const [hours, minutes] = timeInput.split(":");
        let hourNum = parseInt(hours, 10);
        const period = hourNum >= 12 ? "PM" : "AM"; // Determine AM/PM
        hourNum = hourNum % 12 || 12; // Convert 24-hour to 12-hour format
        const formattedTime = `${hourNum}${minutes}`.replace(/\s/g, "");

        // console.log(formattedTime);
        // console.log(timeInput);
        // ✅ Final Data Object
        const formData = {
          action: "create",
          name,
          phone,
          noIc,
          date: formattedDate,
          time: formattedTime,
          people,
          package,
          deposit,
          payment,
          promoter,
          addOns,
          remarks,
          balance,
          discount,
        };

        console.log(formData);

        try {
          const response = await fetch(
            "https://script.google.com/macros/s/AKfycbzw7_o0lVOyIBENGtCXegfXYWpO8eeT9Aw4ScC0PM1LZZX47s1z6HEREIFOogR2zNsd0Q/exec",
            {
              method: "POST",
              headers: {
                "Content-Type": "text/plain", // ✅ Fix CORS issue
              },
              body: JSON.stringify(formData),
            }
          );

          const text = await response.text(); // ✅ Read response as text
          const data = JSON.parse(text); // ✅ Manually parse JSON
          console.log(data);
          if (data.status === "success" && data.id) {
            Swal.fire({
              title: "Success!",
              html: `<strong>Appointment ID:</strong> ${data.id}<br><strong>Name:</strong> ${data.name}<br><strong>Package:</strong> ${data.package}<br><strong>Date:</strong> ${data.date}<br><strong>Time:</strong> ${data.time}`,
              icon: "success",
              confirmButtonText: "Okay",
            }).then(() => {
              document.getElementById("bookingForm").reset(); // Reset form fields
            });
          } else if (data.status === "duplicate") {
            Swal.fire({
              title: "Error",
              text: "This appointment already exists.",
              icon: "error",
              confirmButtonText: "Okay",
            });
          } else {
            Swal.fire({
              title: "Error",
              text: data.message || "Unknown error occurred.",
              icon: "error",
              confirmButtonText: "Okay",
            });
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Failed to submit. Please try again.");
        }
      }

      // Attach event listener to form submit
      document
        .getElementById("bookingForm")
        .addEventListener("submit", submitAppointment);
    </script>
  </body>
</html>
