<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Available Slots</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid black;
        text-align: center;
        padding: 8px;
      }
      th {
        background-color: #f4f4f4;
      }
      .booked {
        background-color: red;
        color: blue;
        text-decoration: underline;
        font-weight: bold;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h2 class="text-center">Available Slots</h2>

      <div class="table-responsive">
        <table class="table table-bordered text-center">
          <thead id="tableHead">
            <tr>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <!-- Bootstrap Modal -->
        <div
          class="modal fade"
          id="bookingModal"
          tabindex="-1"
          aria-labelledby="modalTitle"
          aria-hidden="true"
        >
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Booking Details</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body" id="modalBody">
                <!-- Booking details will be inserted here -->
              </div>
              <div class="modal-footer">
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bootstrap CSS & JS (Include if not already added) -->
        <link
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
          rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
      </div>
    </div>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwgJUIoLPcuw7k03jxBnyzbekVe4b-NwaY0TOS7q8oEXYwRS5W8Q_yMlhosffUlc8rfwA/exec"; // Replace with your actual API URL

      // Convert "7March" to YYYY-MM-DD format
      function parseCustomDate(dateString) {
        const months = {
          January: "01",
          February: "02",
          March: "03",
          April: "04",
          May: "05",
          June: "06",
          July: "07",
          August: "08",
          September: "09",
          October: "10",
          November: "11",
          December: "12",
        };

        let match = dateString.match(/^(\d+)([A-Za-z]+)$/);
        if (!match) return null; // Invalid format

        let day = match[1].padStart(2, "0"); // Ensure two-digit day
        let month = months[match[2]];
        let year = new Date().getFullYear(); // Assume current year

        return `${year}-${month}-${day}`;
      }

      // Convert "415AM" to "04:15 AM"
      function parseCustomTime(timeString) {
        let match = timeString.match(/^(\d{1,2})(\d{2})(AM|PM)$/);
        if (!match) return null;

        let hours = parseInt(match[1]);
        let minutes = match[2];
        let period = match[3];

        if (period === "PM" && hours !== 12) hours += 12;
        if (period === "AM" && hours === 12) hours = 0;

        return `${String(hours).padStart(2, "0")}:${minutes}`;
      }

      function convertTo12HourFormat(time24) {
        if (!time24) return null; // Handle missing/null values
        let [hour, minute] = time24.split(":");
        hour = parseInt(hour);
        let period = hour >= 12 ? "PM" : "AM";
        hour = hour % 12 || 12; // Convert 0 to 12 for AM
        return `${hour}:${minute} ${period}`;
      }

      // Generate dates from today to April 10
      function getDateRange() {
        let rawToday = new Date();
        let today = new Date(rawToday.getTime() + 8 * 60 * 60 * 1000); // Add 8 hours
        let endDate = new Date("2025-04-07");
        let dateArray = [];

        while (today <= endDate) {
          let formattedDate = today.toISOString().split("T")[0]; // YYYY-MM-DD format
          dateArray.push(formattedDate);
          today.setDate(today.getDate() + 1);
        }
        return dateArray;
      }

      function getHead() {
        let rawToday = new Date();
        let today = new Date(rawToday.getTime() + 8 * 60 * 60 * 1000); // Add 8 hours
        let endDate = new Date("2025-04-07");
        let dateArray = [];

        while (today <= endDate) {
          let options = {
            day: "numeric",
            month: "short",
            timeZone: "Asia/Kuala_Lumpur",
          };
          let formattedDate = new Intl.DateTimeFormat("en-MY", options).format(
            today
          ); // "7 Mar", "8 Mar", etc.

          dateArray.push(formattedDate);
          today.setDate(today.getDate() + 1);
        }
        return dateArray;
      }

      // Generate time slots (adjust as needed)
      function getTimeSlots() {
        return [
          "09:30 AM",
          "09:50 AM",
          "10:10 AM",
          "10:30 AM",
          "10:50 AM",
          "11:10 AM",
          "11:30 AM",
          "11:50 AM",
          "12:10 PM",
          "12:30 PM",
          "12:50 PM",
          "1:10 PM",
          "1:30 PM",
          "1:50 PM",
          "2:10 PM",
          "2:30 PM",
          "2:50 PM",
          "3:10 PM",
          "3:30 PM",
          "3:50 PM",
          "4:10 PM",
          "4:30 PM",
          "4:50 PM",
          "5:10 PM",
          "5:30 PM",
          "5:50 PM",
          "6:10 PM",
          "6:30 PM",
          "6:50 PM",
          "7:10 PM",
          "7:30 PM",
          "7:50 PM",
          "8:10 PM",
          "8:30 PM",
          "8:50 PM",
          "9:10 PM",
          "9:30 PM",
          "9:50 PM",
          "10:10 PM",
          "10:30 PM",
          "10:50 PM",
          "11:10 PM",
          "11:30 PM",
          "11:50 PM",
        ];
      }

      function showBookingDetails(booking) {
        let modalTitle = document.getElementById("modalTitle");
        let modalBody = document.getElementById("modalBody");

        // Convert time to 12-hour format with AM/PM
        let formattedTime = formatTimeTo12Hour(booking.time);

        modalTitle.textContent = "Booking Details";
        modalBody.innerHTML = `
    <p><strong>Date:</strong> ${booking.date}</p>
    <p><strong>Time:</strong> ${formattedTime}</p>
    <p><strong>Name:</strong> ${booking.name || "N/A"}</p>
    <p><strong>Phone:</strong> ${booking.phone || "N/A"}</p>
    <p><strong>People:</strong> ${booking.people || "N/A"} people</p>
    <p><strong>Payment:</strong> RM${booking.payment || "0.00"}</p>
  `;

        let bookingModal = new bootstrap.Modal(
          document.getElementById("bookingModal")
        );
        bookingModal.show();
      }

      // ✅ Function to Convert Time to 12-Hour Format with AM/PM
      function formatTimeTo12Hour(timeString) {
        let [hours, minutes] = timeString.split(":").map(Number);
        let period = hours >= 12 ? "PM" : "AM";
        hours = hours % 12 || 12; // Convert 24-hour to 12-hour format
        return `${hours}:${minutes.toString().padStart(2, "0")} ${period}`;
      }

      // Fetch bookings from API
      async function fetchBookings() {
        try {
          let response = await fetch(API_URL);
          let result = await response.json();

          if (result.status === "success") {
            console.log(result.data);
            return result.data.map((b) => ({
              date: parseCustomDate(b.date),
              time: parseCustomTime(b.time),
              name: b.name, // ✅ Include Name
              phone: b.phone, // ✅ Include Phone
              people: b.people, // ✅ Include Number of People
              payment: b.payment, // ✅ Include Payment
            }));
          } else {
            console.error("Failed to fetch bookings");
            return [];
          }
        } catch (error) {
          console.error("Error fetching data:", error);
          return [];
        }
      }

      // Build table
      async function buildTable() {
        let dates = getDateRange();
        let headers = getHead();
        let timeSlots = getTimeSlots();
        let bookings = await fetchBookings();
        // console.log(bookings);

        let tableHead = document.getElementById("tableHead");
        let tableBody = document.getElementById("tableBody");

        // Clear previous table data
        tableHead.innerHTML = "<tr><th>Time</th></tr>";
        tableBody.innerHTML = "";

        // Add date headers
        let headerRow = tableHead.querySelector("tr");
        headers.forEach((date) => {
          let th = document.createElement("th");
          th.textContent = date;
          headerRow.appendChild(th);
        });

        // Create rows for each time slot
        timeSlots.forEach((time) => {
          let row = document.createElement("tr");
          let timeCell = document.createElement("td");
          timeCell.textContent = time;
          row.appendChild(timeCell);

          // Fill each date column
          dates.forEach((date) => {
            let cell = document.createElement("td");
            let booking = bookings.find((b) => {
              let bookedDate = b.date;
              let bookedTime = convertTo12HourFormat(b.time); // Convert to 12-hour format

              return bookedDate === date && bookedTime === time;
            });

            if (booking) {
              cell.textContent = "Booked";
              cell.classList.add("booked");

              // ✅ Add click event to show booking details
              cell.addEventListener("click", () => showBookingDetails(booking));
            } else {
              cell.textContent = "";
            }

            row.appendChild(cell);
          });

          tableBody.appendChild(row);
        });
      }

      // Load table on page load
      document.addEventListener("DOMContentLoaded", buildTable);
    </script>
  </body>
</html>
